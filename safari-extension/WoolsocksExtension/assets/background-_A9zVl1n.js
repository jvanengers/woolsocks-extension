import{i as Lt,s as Yt,t as pt,a as rt}from"./i18n-ChiNe6Ig.js";import{i as oe,t as P}from"./analytics-B6nZXsGu.js";const It=!1,J="https://woolsocks.eu";async function Xt(){const t=await _t(),{wsAnonId:n}=await chrome.storage.local.get(["wsAnonId"]);let e=n;return e||(e=crypto.randomUUID(),await chrome.storage.local.set({wsAnonId:e})),{"x-application-name":"WOOLSOCKS_WEB","x-user-id":t||e,"Content-Type":"application/json"}}let mt,wt=!1;function re(){mt=void 0,wt=!1}async function _t(){if(typeof mt<"u")return mt;if(wt)return null;wt=!0;try{const{wsAnonId:t}=await chrome.storage.local.get(["wsAnonId"]);let n=t;n||(n=crypto.randomUUID(),await chrome.storage.local.set({wsAnonId:n}));const e={"x-application-name":"WOOLSOCKS_WEB","x-user-id":n||""};let o=null;try{const h=await fetch(`${J}/api/wsProxy/user-info/api/v0`,{credentials:"include",headers:e});if(h.ok)try{o=await h.json()}catch{}}catch{}o||(o=(await ce("/user-info/api/v0",e)).data);const r=o?.data?.userId||o?.data?.id||o?.user?.id||o?.id||null;return mt=r,wt=!1,r}catch{return mt=null,wt=!1,null}}const ie=1e3;async function Gt(){try{const t=await _t();return typeof t=="string"&&t.length>0}catch{return!1}}const se=2;async function Ut(t,n){const e=await Xt();async function o(){const f=await chrome.tabs.query({url:[`${J}/*`,`${J.replace("https://","https://www.")}/*`]});return f[0]?.id?{tabId:f[0].id,created:!1}:{tabId:(await chrome.tabs.create({url:`${J}/nl`,active:!1})).id,created:!0}}async function r(f){return new Promise(u=>{try{chrome.tabs.sendMessage(f,{type:"WS_PING"},()=>{u(!chrome.runtime.lastError)})}catch{u(!1)}})}async function h(f){return new Promise(u=>{chrome.tabs.sendMessage(f,{type:"WS_RELAY_FETCH",payload:{url:`${J}/api/wsProxy${t}`,init:{...n,headers:e,credentials:"include"}}},d=>{if(chrome.runtime.lastError||!d)return u({data:null,status:0});try{const s=d.bodyText?JSON.parse(d.bodyText):null;u({data:s,status:d.status})}catch{u({data:null,status:d.status})}})})}let a=!1,m=0;try{const f=await o();m=f.tabId,a=f.created;let u=await r(m),d=0;for(;!u&&d<6;)await new Promise(z=>setTimeout(z,250)),u=await r(m),d++;return await h(m)}catch{return{data:null,status:0}}finally{if(a&&m)try{await chrome.tabs.remove(m)}catch{}}}async function ce(t,n,e){async function o(){const f=await chrome.tabs.query({url:[`${J}/*`,`${J.replace("https://","https://www.")}/*`]});return f[0]?.id?{tabId:f[0].id,created:!1}:{tabId:(await chrome.tabs.create({url:`${J}/nl`,active:!1})).id,created:!0}}async function r(f){return new Promise(u=>{try{chrome.tabs.sendMessage(f,{type:"WS_PING"},()=>u(!chrome.runtime.lastError))}catch{u(!1)}})}async function h(f){return new Promise(u=>{chrome.tabs.sendMessage(f,{type:"WS_RELAY_FETCH",payload:{url:`${J}/api/wsProxy${t}`,init:{...e,headers:n,credentials:"include"}}},d=>{if(chrome.runtime.lastError||!d)return u({data:null,status:0});try{const s=d.bodyText?JSON.parse(d.bodyText):null;u({data:s,status:d.status})}catch{u({data:null,status:d.status})}})})}let a=!1,m=0;try{const f=await o();m=f.tabId,a=f.created;let u=await r(m),d=0;for(;!u&&d<6;)await new Promise(s=>setTimeout(s,250)),u=await r(m),d++;return await h(m)}catch{return{data:null,status:0}}finally{if(a&&m)try{await chrome.tabs.remove(m)}catch{}}}async function it(t,n,e=0){const o=await Xt(),r=`${J}/api/wsProxy${t}`;try{const h=await fetch(r,{credentials:"include",...n,headers:{...o,...n?.headers},method:n?.method||"GET"}),a=h.status;return h.ok?{data:await h.json(),status:a}:await Ut(t,n)}catch{return e<se?(await new Promise(a=>setTimeout(a,ie*(e+1))),await it(t,n,e+1)):await Ut(t,n)}}function Tt(t){if(!t)return"";try{let n=t.trim();return/^https?:\/\//i.test(n)||(n=`https://${n}`),(new URL(n).hostname||"").replace(/^www\./i,"").toLowerCase()}catch{return String(t).replace(/^www\./i,"").toLowerCase()}}function Ot(t){const n=t.split(".");return n.length<=2?n[0]:n.slice(0,-1).join(".")}function le(t,n){if(!t||!n)return!1;if(t===n||t.endsWith(n)||n.endsWith(t))return!0;const e=Ot(t),o=Ot(n);return e===o}function Kt(t){const n=t.replace(/^www\./i,""),e=n.split("."),o=e.length>=2?e[e.length-2]:e[0],r=new Set;return n==="bol.com"||o==="bol"?(r.add("bol.com"),r.add("bol"),r.add("Bol"),r.add("BOL"),Array.from(r).filter(Boolean)):(r.add(o),r.add(o.replace(/[-_]/g," ")),r.add(n),r.add(n.replace(/\./g," ")),r.add(o.toUpperCase()),r.add(o.toLowerCase()),Array.from(r).filter(Boolean))}function de(t,n){if(!Array.isArray(n)||n.length===0)return null;const e=t.toLowerCase().replace(/\s+/g,""),o=n.map(a=>{const m=(a?.data?.name||a?.name||"").toLowerCase().replace(/\s+/g,"");let f=0;return m===e?f=100:m.startsWith(e)&&m.length===e.length+1?f=90:m.startsWith(e)?f=70:m.includes(e)?f=50:e==="bol"&&m==="bol"&&(f=95),{merchant:a,score:f,name:m}});o.sort((a,m)=>m.score!==a.score?m.score-a.score:a.name.length-m.name.length);const r=o[0];if(r&&r.score>0)return r.merchant.data||r.merchant;const h=n[0];return h?.data||h||null}function ue(t){const n=t?.providerReferenceId||t?.productId||t?.id;if(n)return`${J}/nl-NL/giftcards-shop/products/${n}`;const e=(t?.links?.webLink||"").match(/giftcards-shop\/products\/([a-f0-9-]{36})/i);return e?`${J}/nl-NL/giftcards-shop/products/${e[1]}`:void 0}function he(t){if(!t)return null;try{const n=String(t).match(/\/stores(?:\/square)?\/(\d+)(?:[-.]|\/)/);return n?n[1]:null}catch{return null}}function fe(t,n){if(!t)return 0;const e=typeof t.value=="number"?t.value:0,o=typeof t.scalingFactor=="number"?t.scalingFactor:2,r=e/Math.pow(10,o);return(n||"").toUpperCase()==="PERCENTAGE",r}function Wt(t){const e=(t||"").toUpperCase(),o=e.replace(/[^A-Z]/g,"");return o==="GIFTCARD"?"VOUCHERS":o==="GIFTCARDPAYLATER"?"OTHER":o==="CASHBACK"?"ONLINE_CASHBACK":o==="AUTOREWARD"?"AUTOREWARDS":e.includes("GIFT")&&!e.includes("PAY")&&!e.includes("LATER")?"VOUCHERS":e.includes("CASH")?"ONLINE_CASHBACK":e.includes("AUTO")||e.includes("POINT")?"AUTOREWARDS":"OTHER"}async function Dt(t,n="NL",e){let o=t;/^prenatal$/i.test(o)&&(o="prénatal"),/^cadeaubon$/i.test(o)&&(o="keuze cadeaukaart");const r=Kt(o);console.log(`[WS API] searchMerchantByName called with name: "${t}" (adjusted: "${o}"), country: "${n}"`),console.log("[WS API] Generated candidates:",r);for(const h of r){const m=`/merchants-overview/api/v0.0.1/merchants?${new URLSearchParams({name:h,country:n}).toString()}`;console.log(`[WS API] Searching API with URL: ${m}`);const f=await it(m);console.log(`[WS API] API response status: ${f.status}, data:`,f.data);const u=f.data?.data;if(!u||!u.merchants||u.merchants.length===0){console.log(`[WS API] No merchants found for candidate: "${h}"`);continue}console.log(`[WS API] Found ${u.merchants.length} merchants for candidate: "${h}"`);const s=de(h,u.merchants);if(!s?.id)continue;const M=(await it(`/merchants-overview/api/v0.0.1/v2/deals?merchantId=${s.id}&country=${n}`)).data?.data?.deals||[],c=M.filter(l=>Wt(l?.dealType)==="ONLINE_CASHBACK");let et;for(const l of c){if(l?.providerMerchantId){et=String(l.providerMerchantId);break}const D=he(l?.imageUrl);if(D){et=D;break}}const V=await vt().catch(()=>"nl-NL")||"nl-NL",b=String(V),O=encodeURIComponent(String(b.split("-")[0]).toLowerCase()),Z=et?await it(`/cashback/api/v1/merchants/${encodeURIComponent(String(et))}?sortRewardsBy=amount%3Adesc&language=${O}`,{headers:{"Accept-Language":b}}):{data:null,status:0},w=Z.data?.data?.rewards||[];try{const l=Z?.data?.data?.merchant?.webUrl||"",D=Tt(l),R=Tt(e||t);if(D&&R&&!le(R,D)){console.log("[WS API] Skipping merchant due to domain mismatch",{hostDomain:R,webDomain:D,candidate:h});continue}}catch{}let v=0,A=!1;const $=[],x=[],H=[],j=[],W=[];for(const l of M){const D=fe(l.amount,l.amountType||""),R={name:l?.title||s.name||h,rate:D,description:l?.description||l?.siteContents&&l.siteContents[0]||"",imageUrl:l?.imageUrl,dealUrl:ue(l),amountType:l?.amountType,currency:l?.amount?.currency||l?.currencyCode,country:l?.country,usageType:l?.usageType,provider:l?.provider,providerMerchantId:l?.providerMerchantId,providerReferenceId:l?.providerReferenceId,requireOptIn:l?.requireOptIn,conditions:{siteContents:Array.isArray(l?.siteContents)?l.siteContents:[]},merchantId:l?.merchantId},nt=Wt(l?.dealType);if(nt==="VOUCHERS"){let ht=l?.providerReferenceId||l?.productId||l?.id||null;if(!ht&&R.dealUrl){const i=String(R.dealUrl).match(/products\/([A-Za-z0-9-]{8,})/);ht=i?i[1]:null}ht&&H.push({id:ht,item:R})}else if(nt==="ONLINE_CASHBACK"){const dt=l?.providerReferenceId||l?.id;dt&&!R.id&&(R.id=String(dt)),j.push(R)}else nt==="AUTOREWARDS"&&W.push(R)}const Y=[],q=(Z.data?.data?.merchant?.countryCode||n||"").toUpperCase();for(const l of w){const D=(l?.cashbackType||"").toLowerCase()==="percent"?"PERCENTAGE":"FIXED",R=typeof l?.cashBack=="number"?l.cashBack:0;Y.push({id:l?.rewardId?String(l.rewardId):void 0,name:l?.title||s.name||h,rate:R,amountType:D,currency:l?.currencyCode,country:q,usageType:"ONLINE",merchantId:s.id})}async function Q(l){return l.length?(await Promise.all(l.map(async R=>{try{const nt=await it(`/giftcards/api/v0.0.2/products/${encodeURIComponent(R.id)}`),i=((nt?.data&&(nt.data.data?.product||nt.data.product)||null)?.usageType||"").toString().toUpperCase().replace(/[^A-Z]/g,"");return i==="ALL"||i.includes("ONLINE")?R.item:null}catch{return null}}))).filter(Boolean):[]}const p=await Q(H);for(const l of p)x.push(l);if(W.length){const l=Math.max(...W.map(D=>D.rate||0));$.push({name:"Autorewards",deals:W,maxRate:l}),v=Math.max(v,l)}if(x.length){const l=Math.max(...x.map(D=>D.rate||0));$.push({name:"Vouchers",deals:x,maxRate:l}),A=!0,v=Math.max(v,l)}const st=Y.length?Y:j;if(st.length){const l=Math.max(...st.map(D=>D.rate||0));$.push({name:"Online cashback",deals:st,maxRate:l}),v=Math.max(v,l)}return{domain:t,name:s.name||h,cashbackRate:Math.round(v*100)/100,voucherAvailable:A,dealUrl:s.websiteUrl,merchantImageUrl:s.logoUrl,description:s.description?.find(l=>l.lang.toUpperCase()===n)?.text||s.description?.[0]?.text,categories:$.length?$:void 0}}return console.warn("[WS API] merchants search failed (no results for candidates)",r),null}async function gt(t){const e=(t||"").replace(/^www\./i,"").toLowerCase();globalThis.__wsPartnerCache=globalThis.__wsPartnerCache||new Map,globalThis.__wsPartnerInflight=globalThis.__wsPartnerInflight||new Map;const o=globalThis.__wsPartnerCache,r=globalThis.__wsPartnerInflight,h=o.get(e);if(h&&Date.now()-h.at<3e5)return h.val;const a=r.get(e);if(a)return a;const m=(async()=>{try{t.replace(/^www\./,"").toLowerCase()}catch{}const f=Kt(t);console.log(`[WS API] Searching for merchant: ${t}, candidates:`,f);for(const u of f)try{let d=await Dt(u,"NL",t);if(!d&&/^(.*)\.(nl|de|be|fr|it|es)$/i.test(u)){const s=u.replace(/\.(nl|de|be|fr|it|es)$/i,"");d=await Dt(s,"NL",t)}if(d)return console.log(`[WS API] Found merchant: ${d.name} for candidate: ${u}`),o.set(e,{at:Date.now(),val:d}),d}catch(d){console.warn(`[WS API] Error searching for candidate ${u}:`,d)}return console.warn(`[WS API] No merchant found for hostname: ${t} with candidates:`,f),o.set(e,{at:Date.now(),val:null}),null})();r.set(e,m);try{return await m}finally{r.delete(e)}}async function qt(){return{partners:[],lastUpdated:new Date}}async function pe(){return[]}async function me(){}async function ge(t){async function n(e){try{const o=`/rewards/api/v0/rewards/${encodeURIComponent(String(t))}/redirection`;let r;try{e&&(mt=void 0);const z=await _t();z&&(r={"x-user-id":String(z)})}catch{}const h=await vt().catch(()=>"nl-NL")||"nl-NL",a=await it(o,{method:"GET",headers:{...r||{},"Accept-Language":h}}),m=a.status,f=a.data,u=f&&typeof f?.data<"u"?f.data:f,d=u?.linkUrl||u?.redirectUrl||u?.url||u?.link,s=u?.clickId;return typeof d=="string"?{url:d,clickId:s}:m===403&&!e?await n(!0):null}catch{return e?null:await n(!0)}}return await n(!1)}async function ye(t){try{const n=`/cashback/api/v1/merchants/${encodeURIComponent(String(t))}?sortRewardsBy=amount%3Adesc`,e=await it(n),o=e?.data&&(e.data.data?.merchant||e.data.merchant)||null;return o?{termsCondition:o.termsCondition||void 0,additionalInfo:o.additionalInfo||void 0}:null}catch{return null}}async function Pt(){try{const t=await vt();if(t){const n=t.split("-");return n.length===2&&n[1]?n[1].toUpperCase():{nl:"NL",en:"NL",de:"DE",fr:"FR",it:"IT",es:"ES"}[t.toLowerCase()]||"NL"}}catch{}return"NL"}async function vt(){try{const t=await it("/user-info/api/v0");return t.status===200&&t.data?.data&&(t.data.data.language||t.data.data.locale)||null}catch(t){return console.warn("[WS API] Failed to fetch user language:",t),null}}let At=new Map;function we(t){try{const n=t.replace(/^www\./i,"").toLowerCase(),e=n.split(".");return e.length>=2?e.slice(-2).join("."):n}catch{return t}}async function ve(t){const n=we(t),e=At.get(n);if(e&&Date.now()-e.at<6e4)return e.clicks;const o=await _t();if(!o)return At.set(n,{at:Date.now(),clicks:[]}),[];const h=(await it("/cashback/api/v1/cashback/clicks",{method:"GET",headers:{"x-application-name":"WOOLSOCKS_WEB","x-user-id":String(o)}}))?.data?.data?.clicks||[];return At.set(n,{at:Date.now(),clicks:h}),h}async function be(t,n,e){const{partners:o}=await qt(),r=o.find(f=>f.name===t);if(!r)return;const a=(await chrome.storage.local.get("user")).user||{totalEarnings:0,activationHistory:[],settings:{showCashbackPrompt:!0,showVoucherPrompt:!0}};if(!a.activationHistory.find(f=>f.partner===r.name&&f.status==="active")){const f={partner:r.name,timestamp:Date.now(),cashbackRate:r.cashbackRate,estimatedEarnings:0,status:"active"};a.activationHistory.push(f),await chrome.storage.local.set({user:a}),n&&e&&e("active",n),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"Cashback Activated!",message:`You'll earn ${r.cashbackRate}% cashback on ${r.name} purchases`})}}const xe=new Set(["woolsocks.eu","scoupy.nl","scoupy.com","ok.nl","ok.com","shopbuddies.nl","shopbuddies.com"]),ke=600*1e3,U=!0,Jt=600*1e3,lt=new Map,Rt=new Map,ot=new Map,ut=new Map;function Mt(t){return/^https?:\/\//i.test(t)}function G(t){try{return t.replace(/^www\./i,"").toLowerCase()}catch{return t}}function Zt(){try{const t="__wsOcActiveByDomain",n={};for(const[e,o]of ut.entries())n[e]={at:o.at,clickId:o.clickId};chrome.storage.session.set({[t]:n})}catch{}}function xt(t){const n=G(t),e=ut.get(n);return e?{active:Date.now()-e.at<Jt,clickId:e.clickId,at:e.at}:{active:!1}}function bt(t,n,e){const o=G(t),r=Date.now(),h=ut.get(o);h?(h.at=r,e&&(h.clickId=e),typeof n=="number"&&h.tabIds.add(n)):ut.set(o,{at:r,clickId:e,tabIds:new Set(typeof n=="number"?[n]:[])}),Zt();try{P("oc_state_mark_active",{domain:o,click_id:e})}catch{}}function _e(){const t=Date.now();for(const[n,e]of ut.entries())t-e.at>=Jt&&ut.delete(n);Zt()}try{setInterval(()=>{try{_e()}catch{}},60*1e3)}catch{}function Ce(){const t=Date.now();for(const[n,e]of ot.entries())t>e.until&&ot.delete(n)}try{setInterval(()=>{try{Ce()}catch{}},30*1e3)}catch{}function Ie(t){const n=Date.now(),e=ot.get(t);if(e&&n<e.until)return!0;for(const[o,r]of ot.entries())if(t.endsWith(o)&&n<r.until)return!0;return!1}function Ae(t,n){const e=G(n);for(const[o,r]of ut.entries())o!==e&&r.tabIds.delete(t)}function $t(t){const n=G(t);for(const e of xe)if(n===e||n.endsWith("."+e))return!0;return!1}function Qt(t){const n=G(t),e=n.split(".");return e.length>=2?e.slice(-2).join("."):n}function Se(t){try{const e=new URL(t).searchParams,o=r=>(e.get(r)||"").toLowerCase();return!!(e.has("tduid")||/tradedoubler|awin|impact|partnerize|webgains|admitad|zanox|rakuten|orangebuddies/i.test(o("utm_source"))||/tradedoubler|awin|impact|partnerize|webgains|admitad|zanox|rakuten|orangebuddies/i.test(o("utm_campaign"))||e.has("aff")||e.has("affiliate")||e.has("affid")||e.has("utm_medium")&&/aff/i.test(o("utm_medium")))}catch{return!1}}function Le(t){try{const n=Array.from(t.searchParams.keys()).map(o=>o.toLowerCase());if(!n.length)return!0;const e=o=>/^(utm_|gclid|fbclid|ttclid|tt|tduid|affid|affiliate|aff|campaign|adgroup|adset|clickid|pk_|mc_|scid|msclkid|yclid|irclickid|awc)$/i.test(o);return n.every(e)}catch{return!0}}async function Ee(t){try{const{__wsOcLastActivationByDomain:n}=await chrome.storage.local.get("__wsOcLastActivationByDomain"),e=n||{},o=Qt(t);return e[o]||0}catch{return 0}}async function Nt(t){try{const{__wsOcLastActivationByDomain:n}=await chrome.storage.local.get("__wsOcLastActivationByDomain"),e=n||{},o=Qt(t);e[o]=Date.now(),await chrome.storage.local.set({__wsOcLastActivationByDomain:e})}catch{}}function Ft(t){if(!Array.isArray(t)||t.length===0)return null;const n=t.filter(o=>(o.amountType||"PERCENTAGE")==="PERCENTAGE"),e=t.filter(o=>o.amountType==="FIXED");return n.length?n.sort((o,r)=>(r.rate||0)-(o.rate||0))[0]:e.length?e.sort((o,r)=>(r.rate||0)-(o.rate||0))[0]:t.sort((o,r)=>(r.rate||0)-(o.rate||0))[0]}function Bt(t,n){const e=r=>(r||"").toUpperCase(),o=e(n);return t.filter(r=>e(r.country)===o&&e(r.usageType).includes("ONLINE"))}function te(t){try{oe(),chrome.webNavigation.onCommitted.addListener(async n=>{const{tabId:e,frameId:o,url:r}=n;if(o!==0||!Mt(r))return;let h="";try{h=new URL(r).hostname}catch{return}if(!h||$t(h))return;const a=G(h);U&&console.log("[WS OC] nav",{tabId:e,host:a});const m=`${e}:${a}`,f=Date.now(),u=Rt.get(m)||0;if(f-u<1500)return;Rt.set(m,f);try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_scan_start",host:a})}catch{}let d=ot.get(a);if(!d){for(const[w,v]of ot.entries())if(a.endsWith(w)){d=v;break}}if(d&&Date.now()<d.until){U&&console.log("[WS OC] landed (domain-fallback)",{tabId:e,host:a});try{bt(a,e,d.clickId)}catch{}t("active",e);try{await chrome.storage.local.set({__wsOcPopupData:{domain:a,partnerName:d.partnerName||a,rate:d.deal&&d.deal.rate||0,amountType:d.deal&&d.deal.amountType||"PERCENTAGE",title:d.deal&&d.deal.name||"Online aankoop",affiliateUrl:d.deal&&d.deal.affiliateUrl||null,dealId:d.deal&&d.deal.id||null,clickId:d.clickId||null,conditions:d.deal&&d.deal.conditions||null,timestamp:Date.now()}})}catch{}try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_activated",host:a,deals:d.deal?[d.deal]:[],dealId:d.deal?.id,providerMerchantId:d.deal?.providerMerchantId})}catch{}try{P("oc_state_reemit",{domain:a,reason:"domain_fallback"})}catch{}ot.delete(a);return}else if(U)try{const w=Array.from(ot.keys()),v=ot.has(a),A=w.find(x=>a.endsWith(x));console.log("[WS OC] fallback-miss",{host:a,foundExact:v,foundSuffix:A,reason:d||v||A?"expired":"not_found"})}catch{}const s=lt.get(e);if(s&&U)try{const w=G(s.expectedFinalHost);console.log("[WS OC] pending-compare",{tabId:e,currentUrl:r,currentHost:a,expectedHost:w,rawExpected:s.expectedFinalHost})}catch{}if(s&&a.endsWith(G(s.expectedFinalHost))){U&&console.log("[WS OC] landed",{tabId:e,host:a});try{await Nt(a)}catch{}try{bt(a,e,s.deal.clickId)}catch{}try{if((()=>{if(!s.originalUrl||s.restoredOnce)return!1;try{const $=new URL(r),x=new URL(s.originalUrl);if(x.hostname.replace(/^www\./i,"").toLowerCase()!==$.hostname.replace(/^www\./i,"").toLowerCase())return!1;const H=(x.pathname||"/")!=="/",j=x.search?!Le(x):!1;return(H||j)&&s.originalUrl!==r}catch{return!1}})()){U&&console.log("[WS OC] restoring deep link",{from:r,to:s.originalUrl}),lt.set(e,{...s,restoredOnce:!0});try{P("oc_restore_deeplink",{domain:a,partner_name:s.partnerName})}catch{}await chrome.tabs.update(e,{url:s.originalUrl});return}}catch{}t("active",e);const w=s.deal.merchantId?await ye(s.deal.merchantId):null;await chrome.storage.local.set({__wsOcPopupData:{domain:a,partnerName:s.partnerName,rate:s.deal.rate,amountType:s.deal.amountType||"PERCENTAGE",title:s.deal.name,affiliateUrl:s.deal.affiliateUrl||null,dealId:s.deal.id,clickId:s.deal.clickId||null,conditions:w||s.deal.conditions||null,timestamp:Date.now()}}),P("oc_activated",{domain:a,partner_name:s.partnerName,deal_id:s.deal.id,amount_type:s.deal.amountType||"PERCENTAGE",rate:s.deal.rate,click_id:s.deal.clickId});const v=s.deal&&Array.isArray(s.deals)?s.deals:[s.deal];try{globalThis.__wsLastMerchantWebUrl=s.merchantWebUrl||null}catch{}try{await chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_activated",host:a,deals:v,dealId:s.deal.id,providerMerchantId:s.deal.providerMerchantId})}catch{}try{P("oc_state_reemit",{domain:a,reason:"post_landing"})}catch{}try{setTimeout(()=>{try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_activated",host:a,deals:v,dealId:s.deal.id,providerMerchantId:s.deal.providerMerchantId});try{P("oc_state_reemit",{domain:a,reason:"delayed"})}catch{}}catch{}},1200)}catch{}try{const A="__wsOcActivePillByDomain",x=(await chrome.storage.session.get(A))[A]||{};x[a]=!0,await chrome.storage.session.set({[A]:x})}catch{}lt.delete(e);return}if(s){const w=G(s.expectedFinalHost),v=s.affiliateHost?G(s.affiliateHost):"",A=v&&a.endsWith(v);if(!a.endsWith(w)&&!A){const $=Date.now()-(s.createdAt||0);U&&console.log("[WS OC] clearing-stale-pending",{tabId:e,currentHost:a,expectedHost:w,affiliateHost:v,age:$}),lt.delete(e)}else{if(U)try{console.log("[WS OC] pending-nonmatch",{tabId:e,currentUrl:r,currentHost:a,expectedHost:w,rawExpected:s.expectedFinalHost})}catch{console.log("[WS OC] pending-nonmatch",{tabId:e,url:r})}return}}if(Se(r)){U&&console.log("[WS OC] affiliate markers detected on landing",{url:r});try{const w=await gt(a);if(w){const v=await Pt(),A=(w.categories||[]).find(H=>/online\s*cashback/i.test(String(H?.name||""))||/cashback/i.test(String(H?.name||""))),$=A?Bt(A.deals,v):[],x=Ft($);try{bt(a,e)}catch{}t("active",e),await chrome.storage.local.set({__wsOcPopupData:{domain:a,partnerName:w.name,rate:x?.rate||0,amountType:x?.amountType||"PERCENTAGE",title:x?.name||"Online aankoop",affiliateUrl:x?.affiliateUrl||null,dealId:x?.id||null,clickId:null,conditions:x?.conditions||null,timestamp:Date.now()}}),P("oc_activated",{domain:a,partner_name:w.name,deal_id:x?.id,amount_type:x?.amountType||"PERCENTAGE",rate:x?.rate||0,reason:"affiliate_params"});try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_activated",host:a,deals:$,dealId:x?.id,providerMerchantId:x?.providerMerchantId})}catch{}try{P("oc_state_reemit",{domain:a,reason:"organic_affiliate"})}catch{}try{const H="__wsOcActivePillByDomain",W=(await chrome.storage.session.get(H))[H]||{};W[a]=!0,await chrome.storage.session.set({[H]:W})}catch{}return}}catch{}}try{if(!(((await chrome.storage.local.get("user")).user||{settings:{}})?.settings?.autoActivateOnlineCashback!==!1))return}catch{}const z=await Ee(a);if(z&&Date.now()-z<ke){P("oc_blocked",{domain:a,reason:"cooldown"}),U&&console.log("[WS OC] blocked by cooldown",{domain:a,until:z});return}try{xt(a).active&&t("active",e)}catch{}const M=await gt(a);if(!M){U&&console.log("[WS OC] no partner for",a);return}P("oc_partner_detected",{domain:a,partner_name:M.name}),U&&console.log("[WS OC] partner",{name:M.name});try{const w=await ve(a),v=a,A=W=>(W||"").toLowerCase().replace(/\s+/g,""),$=W=>(W||"").toLowerCase().replace(/[^a-z0-9]+/g,""),x=A(M.name),H=$(v.replace(/\./g,""));let j=null;for(const W of w||[]){const Y=A(W?.store?.name),q=String(W?.store?.urlPathSegment||"").toLowerCase(),Q=$(q),p=Y&&(Y===x||Y.includes(x)||x.includes(Y)),st=!!q&&(q.includes(v)||Q.includes(H));if(p||st){j=W;break}}if(j&&j.clickDate){const W=new Date(j.clickDate).getTime();if(Number.isFinite(W)&&Date.now()-W<=600*1e3){U&&console.log("[WS OC] server-click active",{domain:a,clickId:j.clickId,at:j.clickDate});try{bt(a,e,j.clickId||void 0)}catch{}try{await Nt(a)}catch{}t("active",e);try{const Y="__wsOcActivePillByDomain",Q=(await chrome.storage.session.get(Y))[Y]||{};Q[a]=!0,await chrome.storage.session.set({[Y]:Q})}catch{}try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_activated",host:a,deals:[],dealId:null,providerMerchantId:null})}catch{}return}}}catch{}const c=await Pt(),et=(M.categories||[]).find(w=>/online\s*cashback/i.test(String(w?.name||""))||/cashback/i.test(String(w?.name||"")));if(!et){P("oc_blocked",{domain:a,reason:"no_deals"}),U&&console.log("[WS OC] no online cashback category");return}const V=Bt(et.deals,c);if(!V.length){P("oc_blocked",{domain:a,reason:"no_country_match",country:c}),U&&console.log("[WS OC] no eligible deals for country",c);return}const b=Ft(V);if(!b||!b.id){P("oc_blocked",{domain:a,reason:"no_link"}),U&&console.log("[WS OC] best deal missing id",b);return}P("oc_eligible",{domain:a,partner_name:M.name,deals_count:V.length,deal_id:b.id,amount_type:b.amountType,rate:b.rate,country:c});try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_deals_found",host:a,deals:V})}catch{}U&&console.log("[WS OC] eligible",{dealId:b.id,rate:b.rate,amountType:b.amountType}),P("oc_redirect_requested",{domain:a,deal_id:b.id,provider:b.provider});try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_redirect_requested",host:a})}catch{}U&&console.log("[WS OC] requesting redirect",{dealId:b.id});try{if(xt(a).active){U&&console.log("[WS OC] skip redirect - already active",{host:a});return}}catch{}if(Ie(a)){U&&console.log("[WS OC] skip redirect - pending in-flight",{host:a});return}let O=null;try{O=await ge(b.id)}catch{}if(!O||!O.url){U&&console.log("[WS OC] no redirect url returned (likely not logged in)");try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_login_required",host:a,deals:V,providerMerchantId:b.providerMerchantId})}catch{}return}try{const w=new URL(O.url).hostname;P("oc_redirect_issued",{domain:a,deal_id:b.id,link_host:w,click_id:O.clickId})}catch{P("oc_redirect_issued",{domain:a,deal_id:b.id,click_id:O.clickId})}U&&console.log("[WS OC] navigating to affiliate",{url:O.url}),b.affiliateUrl=O.url,b.clickId=O.clickId,b.providerMerchantId=b.providerMerchantId||V[0]?.providerMerchantId;const Z={expectedFinalHost:a,partnerName:M.name,deal:b};Z.deals=V,lt.set(e,Z);try{let w="";try{w=G(new URL(O.url).hostname)}catch{}const v=Date.now()+15e4;ot.set(a,{affiliateHost:w,clickId:O.clickId,partnerName:M.name,deal:b,originalUrl:r,until:v}),U&&console.log("[WS OC] set domain-pending",{key:a,affiliateHost:w,until:v})}catch{}try{let w="";try{w=G(new URL(O.url).hostname)}catch{}lt.set(e,{expectedFinalHost:a,partnerName:M.name,deal:b,originalUrl:r,affiliateHost:w,createdAt:Date.now()}),await chrome.tabs.update(e,{url:O.url}),P("oc_redirect_navigated",{domain:a,deal_id:b.id,click_id:O.clickId})}catch{try{const v=await chrome.tabs.create({url:O.url,active:!0});if(v?.id){let A="";try{A=G(new URL(O.url).hostname)}catch{}lt.set(v.id,{expectedFinalHost:a,partnerName:M.name,deal:b,originalUrl:r,affiliateHost:A,createdAt:Date.now()}),P("oc_redirect_navigated",{domain:a,deal_id:b.id,click_id:O.clickId}),U&&console.log("[WS OC] opened new tab for affiliate",{tabId:v.id})}}catch{}lt.delete(e)}},{url:[{schemes:["http","https"]}]}),chrome.webNavigation.onCompleted.addListener(async n=>{const{tabId:e,frameId:o,url:r}=n;if(o!==0||!Mt(r))return;let h="";try{h=new URL(r).hostname}catch{return}if(!h||$t(h))return;const a=G(h);try{const m="__wsOcActivePillByDomain",f=(await chrome.storage.session.get(m))[m];if(f&&f[a])try{chrome.tabs.sendMessage(e,{__wsOcUi:!0,kind:"oc_activated",host:a,deals:[],dealId:null,providerMerchantId:null})}catch{}}catch{}},{url:[{schemes:["http","https"]}]})}catch(n){console.warn("[WS] webNavigation listener could not be registered:",n)}}async function Et(){}chrome.runtime.onInstalled.addListener(Et);chrome.runtime.onStartup?.addListener(Et);let St=0;chrome.cookies.onChanged.addListener(({cookie:t})=>{try{t?.domain&&t.domain.includes("woolsocks.eu")&&(St&&clearTimeout(St),St=setTimeout(async()=>{try{re(),await Gt()&&chrome.runtime.sendMessage({type:"SESSION_UPDATED",active:!0})}catch{}try{Et()}catch{}},500))}catch{}});let Ht=!1,kt=!1;async function ee(){if(!kt){try{await Lt()}catch{}kt=!0}}const jt={neutral:{16:"icons/icon-grey-16.png",32:"icons/icon-grey-32.png",48:"icons/icon-grey-48.png"},available:{16:"icons/icon-yellow-16.png",32:"icons/icon-yellow-32.png",48:"icons/icon-yellow-48.png"},active:{16:"icons/icon-green-16.png",32:"icons/icon-green-32.png",48:"icons/icon-green-48.png"},voucher:{16:"icons/icon-yellow-16.png",32:"icons/icon-yellow-32.png",48:"icons/icon-yellow-48.png"},error:"icons/state-error-48.png"};function F(t,n){const e=jt[t]||jt.neutral,o={neutral:rt().icons.noDeals,available:rt().icons.cashbackAvailable,active:rt().icons.cashbackActive,voucher:rt().icons.voucherAvailable,error:rt().icons.attentionNeeded};chrome.action.setIcon({path:e,tabId:n}),chrome.action.setTitle({title:o[t],tabId:n})}chrome.runtime.onInstalled.addListener(async()=>{await Lt(),kt=!0;const t=await vt();if(t){const e=Yt(t);console.log(`[WS] Language set from API: ${e}`)}else console.log("[WS] Using cached/default language");const n={totalEarnings:0,activationHistory:[],settings:{showCashbackPrompt:!0,showVoucherPrompt:!0,autoActivateOnlineCashback:!0}};chrome.storage.local.set({user:n}),await me(),te(F)});chrome.runtime.onStartup?.addListener(async()=>{await Lt(),kt=!0;const t=await vt();if(t){const n=Yt(t);console.log(`[WS] Language refreshed from API on startup: ${n}`)}try{te(F)}catch{}});const Ue=["woolsocks.eu","scoupy.nl","scoupy.com","ok.nl","ok.com","shopbuddies.nl","shopbuddies.com"];function ne(t){const n=t.replace(/^www\./,"").toLowerCase();return Ue.some(e=>n===e||n.endsWith("."+e))}const zt=new Map,Te=2e3;async function ae(t,n){if(await ee(),!n){F("neutral",t);return}try{const e=new URL(n);if(n.startsWith("chrome://")||n.startsWith("chrome-extension://")||n.startsWith("brave://")||n.startsWith("edge://")||n.startsWith("firefox://")||n.startsWith("moz-extension://")||n.startsWith("about:")||n.startsWith("file://")){F("neutral",t);return}if(ne(e.hostname)){F("neutral",t);return}try{if(xt(e.hostname).active){F("active",t);return}}catch{}const o=`${t}:${e.hostname.replace(/^www\./,"").toLowerCase()}`,r=zt.get(o)||0;if(Date.now()-r<Te)return;zt.set(o,Date.now());try{Ae(t,e.hostname)}catch{}const h=await gt(e.hostname);h?((await chrome.storage.local.get("user")).user||{totalEarnings:0,activationHistory:[],settings:{showCashbackPrompt:!0,showVoucherPrompt:!0}}).activationHistory.find(u=>u.partner===h.name&&u.status==="active")?F("active",t):(h.voucherAvailable&&e.pathname.includes("checkout"),F("available",t)):F("neutral",t)}catch{F("neutral",t)}}chrome.tabs.onUpdated.addListener((t,n,e)=>{(n.status==="complete"||n.url)&&ae(t,n.url??e.url)});chrome.tabs.onActivated.addListener(async t=>{const n=await chrome.tabs.get(t.tabId);await ae(t.tabId,n.url)});chrome.action.onClicked.addListener(async t=>{if(!(!t.id||!t.url))try{const n=new URL(t.url);if(t.url.startsWith("chrome://")||t.url.startsWith("chrome-extension://")||t.url.startsWith("brave://")||t.url.startsWith("edge://")||t.url.startsWith("firefox://")||t.url.startsWith("moz-extension://")||t.url.startsWith("about:")||t.url.startsWith("file://")){F("neutral",t.id);return}if(ne(n.hostname)){F("neutral",t.id);return}const e=await gt(n.hostname);if(!e){F("neutral",t.id);return}const r=(await chrome.storage.local.get("user")).user||{totalEarnings:0,activationHistory:[],settings:{showCashbackPrompt:!0,showVoucherPrompt:!0}};if(r.activationHistory.find(a=>a.partner===e.name&&a.status==="active"))chrome.action.openPopup();else{const a={partner:e.name,timestamp:Date.now(),cashbackRate:e.cashbackRate,estimatedEarnings:0,status:"active"};r.activationHistory.push(a),await chrome.storage.local.set({user:r}),F("active",t.id),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:rt().notifications.cashbackActivated,message:pt("notifications.cashbackActivatedMessage",{rate:String(e.cashbackRate),partner:e.name})})}}catch(n){console.error("Error activating cashback:",n),F("error",t.id)}});chrome.runtime.onMessage.addListener((t,n,e)=>{if(t?.type==="WS_CAPTURE_TOKEN"&&typeof t.token=="string"&&t.token.length>10)return(async()=>(await chrome.storage.local.set({apiToken:t.token}),Ht||(Ht=!0,console.log("[WS] Captured and stored API token")),e({ok:!0})))(),!0;if(t?.type==="SET_ICON"&&typeof t.state=="string")return F(t.state),e({ok:!0}),!1;if(t?.type==="CHECKOUT_DETECTED")return Oe(t.checkoutInfo,n.tab?.id),e({ok:!0}),!1;if(t?.type==="ACTIVATE_CASHBACK")return be(t.partner,n.tab?.id,F),e({ok:!0}),!1;if(t?.type==="CHECK_MERCHANT_SUPPORT")return(async()=>{const o=await gt(t.hostname);e({supported:!!o,partner:o})})(),!0;if(t?.type==="CHECK_CASHBACK_STATUS")return(async()=>{const h=((await chrome.storage.local.get("user")).user||{activationHistory:[]}).activationHistory.find(a=>a.partner===t.partnerName&&a.status==="active");e({active:!!h})})(),!0;if(t?.type==="OPEN_VOUCHER_PRODUCT"){const{url:o}=t;return o&&typeof o=="string"?(chrome.tabs.create({url:o}),e({ok:!0})):e({ok:!1,error:"Missing URL"}),!1}else if(t?.type==="OPEN_URL"){const{url:o}=t;return o&&typeof o=="string"?(chrome.tabs.create({url:o}),e({ok:!0})):e({ok:!1,error:"Missing URL"}),!1}else{if(t?.type==="GET_ALL_PARTNERS")return(async()=>{const o=await qt();e(o)})(),!0;if(t?.type==="CHECK_ACTIVE_SESSION")return(async()=>{const o=await Gt();e({active:o})})(),!0;if(t?.type==="REQUEST_ACTIVATION_STATE"){try{const{domain:o}=t,r=xt(o||"");try{P("oc_state_query",{domain:(o||"").replace(/^www\./,"").toLowerCase(),active:!!r.active})}catch{}e(r)}catch{e({active:!1})}return!0}else if(t?.type==="REFRESH_PARTNERS")return(async()=>{const o=await pe();e({partners:o,lastUpdated:new Date})})(),!0}});async function Oe(t,n){if(await ee(),!n||(console.log("[WS] handleCheckoutDetected called with:",t),console.log(pt("debug.checkoutDetected",{merchant:t.merchant})),!((await chrome.storage.local.get("user")).user||{settings:{showVoucherPrompt:!0}}).settings.showVoucherPrompt))return;if(t.merchant.includes("bol.com")){console.log("[WS] Special case: bol.com detected, showing Woolsocks All-in-One voucher");const u={name:"Woolsocks All-in-One",cashbackRate:4,voucherAvailable:!0,voucherProductUrl:"https://woolsocks.eu/nl-NL/giftcards-shop/products/3bb42619-ac4c-4934-a5c2-eec7a7530afe",merchantImageUrl:"",categories:[{name:"Vouchers",deals:[{name:"Woolsocks All-in-One",rate:4,description:"1 voucher, vele merken",imageUrl:"",dealUrl:"https://woolsocks.eu/nl-NL/giftcards-shop/products/3bb42619-ac4c-4934-a5c2-eec7a7530afe"}],maxRate:4}]},d=t.total>0?t.total:50;console.log("[WS] Using checkout total:",d,"(original was:",t.total,")"),console.log(pt("debug.showingOffer",{name:u.name,rate:String(u.cashbackRate)}));const s=c=>chrome.runtime.getURL(c),z=["public/icons/Payment method icon_VISA.png","public/icons/Payment method icon_mastercard.png","public/icons/Payment method icon_IDEAL.png","public/icons/Payment method icon_APPLEPAY.png","public/icons/Payment method icon_GPAY.png"],M={uspIconUrl:s("public/icons/Circle checkmark.svg"),wsLogoUrl:s("public/icons/Woolsocks-logo-large.svg"),externalIconUrl:s("public/icons/External-link.svg"),paymentIconUrls:z.map(s)};chrome.scripting.executeScript({target:{tabId:n},world:"MAIN",func:c=>{try{window.__wsTranslations=c}catch{}},args:[rt().voucher]}).then(()=>chrome.scripting.executeScript({target:{tabId:n},world:"MAIN",func:Vt,args:[u,d,M]})).catch(c=>{console.warn("[WS] Failed to inject/render voucher panel:",c)});return}t.merchant.includes("thuisbezorgd")&&(console.log("[WS] Adding extra delay for Thuisbezorgd to ensure page is fully loaded"),await new Promise(u=>setTimeout(u,2e3)));const r=await gt(t.merchant);if(console.log(rt().debug.partnerData,r),!r){console.log(pt("debug.noMerchant",{merchant:t.merchant}));return}if(!r.voucherAvailable){console.log(pt("debug.noVouchers",{name:r.name}));return}const h=t.total;console.log(pt("debug.showingOffer",{name:r.name,rate:String(r.cashbackRate)}));const a=u=>chrome.runtime.getURL(u),m=["public/icons/Payment method icon_VISA.png","public/icons/Payment method icon_mastercard.png","public/icons/Payment method icon_IDEAL.png","public/icons/Payment method icon_APPLEPAY.png","public/icons/Payment method icon_GPAY.png"],f={uspIconUrl:a("public/icons/Circle checkmark.svg"),wsLogoUrl:a("public/icons/Woolsocks-logo-large.svg"),externalIconUrl:a("public/icons/External-link.svg"),paymentIconUrls:m.map(a)};chrome.scripting.executeScript({target:{tabId:n},world:"MAIN",func:u=>{try{window.__wsTranslations=u}catch{}},args:[rt().voucher]}).then(()=>chrome.scripting.executeScript({target:{tabId:n},world:"MAIN",func:Vt,args:[r,h,f]})).catch(u=>{console.warn("[WS] Failed to inject/render voucher panel:",u)})}function Vt(t,n,e){const o=document.getElementById("woolsocks-voucher-prompt");if(o)try{o.remove()}catch{}const r=window.__wsTranslations,h={title:"Voucher",purchaseAmount:"Purchase amount",cashbackText:"You'll get ",cashbackSuffix:" of cashback",viewDetails:"View voucher details",usps:{instantDelivery:"Instant delivery",cashbackOnPurchase:"% cashback on purchase",useOnlineAtCheckout:"Use online at checkout"},instructions:"Buy the voucher at Woolsocks.eu and put the vouchercode in the field at checkout."},a=r&&r.voucher?r:{voucher:r||h};function m(i){const g=window.location.hostname,S=Date.now()+i;try{const k=window.localStorage.getItem("__wsVoucherDismissals"),_=k?JSON.parse(k):{};_[g]=S,window.localStorage.setItem("__wsVoucherDismissals",JSON.stringify(_))}catch{try{document.documentElement.setAttribute("data-ws-voucher-dismissed-until",String(S))}catch{}}}const f=[],u=i=>{if(!(!i||typeof i!="string"))try{return i.replace(/^http:/i,"https:")}catch{return}},d=Array.isArray(t.categories)?t.categories.find(i=>/voucher/i.test(String(i?.name||""))):null;if(d&&Array.isArray(d.deals))for(const i of d.deals)f.push({name:i?.name,cashbackRate:typeof i?.rate=="number"?i.rate:void 0,imageUrl:u(i?.imageUrl),url:i?.dealUrl});else if(Array.isArray(t.allVouchers))for(const i of t.allVouchers)f.push({name:i.name,cashbackRate:i.cashbackRate,imageUrl:u(i.imageUrl),url:i.url});else t.voucherProductUrl&&f.push({name:(t.name||"")+" Voucher",cashbackRate:t.cashbackRate,imageUrl:u(t.merchantImageUrl),url:t.voucherProductUrl});const s=f.filter(i=>typeof i.cashbackRate=="number"&&i.cashbackRate>0).sort((i,g)=>(g.cashbackRate||0)-(i.cashbackRate||0)),z=s[0],M=s.length>1,c=document.createElement("div");c.id="woolsocks-voucher-prompt",c.style.cssText=`
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 380px;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 16px;
    border: 4px solid var(--brand, #FDC408);
    background: var(--brand, #FDC408);
    box-shadow: -2px 2px 4px rgba(0, 0, 0, 0.08);
    z-index: 2147483647;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    opacity: 0;
    transform: translateY(10px) scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s ease;
    cursor: move;
  `;let et=0;const V=typeof(s[et]?.cashbackRate??t.cashbackRate)=="number"?s[et]?.cashbackRate??t.cashbackRate:0,b=(n*V/100).toFixed(2),O=e?.uspIconUrl||"",Z=a&&a.voucher&&a.voucher.usps||{instantDelivery:"Instant delivery",cashbackOnPurchase:"% cashback on purchase",useOnlineAtCheckout:"Use online at checkout"};try{window.location.hostname.toLowerCase().includes("dille-kamille")&&(Z.useOnlineAtCheckout="Voucher only usable in-store (not online)",a&&a.voucher&&(a.voucher.instructions="This voucher can only be used in-store at Dille & Kamille (not online)."))}catch{}const w=[{text:Z.instantDelivery},...Number.isFinite(V)&&V>0?[{text:`${V}${Z.cashbackOnPurchase}`}]:[],{text:Z.useOnlineAtCheckout}];let v=u(z?.imageUrl||t.merchantImageUrl)||"";try{const i=window.location.hostname.toLowerCase();!v&&i.includes("prenatal.nl")&&(v="https://www.prenatal.nl/favicon.ico")}catch{}const A=z?.name||t.name||"Gift Card",x=(e?.paymentIconUrls||[]).filter(Boolean).map(i=>`
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; min-width: 0;">
      <img src="${i}" alt="payment" style="height: 36px; width: auto; display: block; max-width: 100%; object-fit: contain;" />
    </div>
  `).join(""),H=e?.wsLogoUrl||"",j=e?.externalIconUrl||"";c.innerHTML=`
    <div style="padding: 16px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: #100B1C;">${t.name}</h3>
        <button id="ws-close" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #0F0B1C; line-height: 1;">×</button>
      </div>

      <div style="border-radius: 16px; background: var(--bg-main, #F5F5F6); padding: 16px;">
        <div style="margin-bottom: 16px; display: flex; flex-direction: column; align-items: center;">
          <div style="color: #100B1C; text-align: center; font-feature-settings: 'liga' off, 'clig' off; font-family: Woolsocks, sans-serif; font-size: 12px; font-style: normal; font-weight: 400; line-height: 145%; letter-spacing: 0.15px;">${a.voucher.purchaseAmount}</div>
          <div style="color: #100B1C; text-align: center; font-feature-settings: 'liga' off, 'clig' off; font-family: Woolsocks, sans-serif; font-size: 16px; font-style: normal; font-weight: 700; line-height: 145%;">€${n.toFixed(2)}</div>
        </div>
        ${M?`
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
          <div id="voucher-carousel" style="display: flex; gap: 8px; overflow-x: hidden; scroll-behavior: smooth; padding: 8px 0;">
            ${s.map((i,g)=>`
              <div class="voucher-card" data-index="${g}" style="min-width: 259px; background: white; border-radius: 8px; padding: 16px; display: flex; gap: 16px; align-items: flex-start; cursor: pointer; transition: transform 0.2s ease;">
                <div style="width: 111px; height: 74px; border-radius: 8px; background: #F3F4F6; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                  ${i.imageUrl?`<img src="${i.imageUrl}" alt="${i.name}" referrerpolicy="no-referrer" decoding="async" loading="eager" onerror="console.warn('[WS] Image failed to load:', '${i.imageUrl}'); this.style.display='none'; this.nextElementSibling.style.display='flex';" style="width: 100%; height: 100%; object-fit: contain;"><div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; background: #F3F4F6; border-radius: 8px; font-size: 12px; color: #666;">Voucher</div>`:`${e?.wsLogoUrl?`<img src='${e.wsLogoUrl}' alt="${i.name}" style="width: 100%; height: 100%; object-fit: contain;">`:'<div style="font-size: 12px; color: #666;">Voucher</div>'}`}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; padding: 2px 4px; justify-content: center; align-items: flex-start; gap: 8px; border-radius: 4px; background: #ECEBED; font-size: 13px; color: #6B7280; margin-bottom: 2px; width: fit-content;">${i.cashbackRate}% cashback</div>
                  <div style="font-size: 16px; font-weight: 700; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${i.name}</div>
                </div>
              </div>
            `).join("")}
          </div>
          <div id="carousel-navigation" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <div id="carousel-left-arrow" class="carousel-arrow" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.5;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M15 18L9 12L15 6" stroke="#0F0B1C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div id="carousel-indicators" style="display: flex; justify-content: center; gap: 4px;">
              ${s.map((i,g)=>`
                <div class="carousel-dot" data-index="${g}" style="width: 6px; height: 6px; border-radius: ${g===0?"3px":"50%"}; background: ${g===0?"#0F0B1C":"#D1D5DB"}; cursor: pointer; transition: all 0.2s ease;"></div>
              `).join("")}
            </div>
            <div id="carousel-right-arrow" class="carousel-arrow" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M9 18L15 12L9 6" stroke="#0F0B1C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
        </div>
        `:`
        <div style="display: flex; padding: 16px; flex-direction: column; justify-content: center; align-items: flex-start; gap: 16px; border-radius: 8px; background: var(--bg-neutral, #FFF); margin-bottom: 16px;">
          <div style="display: flex; gap: 12px; align-items: center; width: 100%;">
            <div style="width: 72px; height: 48px; border-radius: 8px; background: #F3F4F6; overflow: hidden; display: flex; align-items: center; justify-content: center;">
              ${v?`<img src="${v}" alt="${A}" referrerpolicy="no-referrer" decoding="async" loading="eager" onerror="console.warn('[WS] Image failed to load:', '${v}'); this.style.display='none'; this.nextElementSibling.style.display='flex';" style="width: 100%; height: 100%; object-fit: contain;"><div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; background: #F3F4F6; border-radius: 8px; font-size: 12px; color: #666;">Voucher</div>`:`${e?.wsLogoUrl?`<img src='${e.wsLogoUrl}' alt="${A}" style="width: 100%; height: 100%; object-fit: contain;">`:'<div style="font-size: 12px; color: #666;">Voucher</div>'}`}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; padding: 2px 4px; justify-content: center; align-items: flex-start; gap: 8px; border-radius: 4px; background: #ECEBED; font-size: 13px; color: #6B7280; margin-bottom: 2px; width: fit-content;">${V}% cashback</div>
              <div style="font-size: 16px; font-weight: 700; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${A}</div>
            </div>
          </div>
        </div>
        `}

        <div style="display: flex; width: 310px; height: 43px; padding: 8px 16px; justify-content: center; align-items: baseline; gap: 4px; margin-bottom: 16px;">
          <span style="color: #8564FF; text-align: center; font-feature-settings: 'liga' off, 'clig' off; font-family: Woolsocks, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; line-height: 145%;">${a.voucher.cashbackText}</span>
          <span style="display: flex; padding: 2px 4px; justify-content: center; align-items: center; gap: 8px; border-radius: 6px; background: #8564FF; color: #FFF; text-align: center; font-feature-settings: 'liga' off, 'clig' off; font-family: Woolsocks, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; line-height: 145%;">€${b}</span>
          <span style="color: #8564FF; text-align: center; font-feature-settings: 'liga' off, 'clig' off; font-family: Woolsocks, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; line-height: 145%;">${a.voucher.cashbackSuffix}</span>
        </div>

        <div style="display: flex; align-items: center;">
          <button id="ws-use-voucher" style="display: flex; width: 100%; height: 48px; padding: 0 16px 0 24px; justify-content: center; align-items: center; gap: 16px; border-radius: 4px; background: var(--action-button-fill-bg-default, #211940); color: var(--action-button-fill-content-default, #FFF); border: none; font-family: Woolsocks, sans-serif; font-size: 16px; font-style: normal; font-weight: 500; line-height: 140%; text-align: center; font-feature-settings: 'liga' off, 'clig' off; cursor: pointer;">
            <span>${a.voucher.viewDetails}</span>
            ${j?`<img src="${j}" alt="open" style="width:20px;height:20px;display:block;" />`:""}
          </button>
        </div>
      </div>


      <div style="display: flex; width: 100%; padding: 16px; box-sizing: border-box; flex-direction: column; justify-content: center; align-items: flex-start; gap: 8px; border-radius: 8px; border: 1px solid var(--semantic-green-75, #B0F6D7); background: rgba(255, 255, 255, 0.50); margin: 12px 0;">
        ${w.map(i=>`
          <div style="display: flex; align-items: center; gap: 8px;">
            ${O?`<img src="${O}" alt="check" style="width:16px;height:16px;display:block;" />`:""}
            <span style="font-size: 13px; color: #111827;">${i.text}</span>
          </div>
        `).join("")}
      </div>

      <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 6px 0 14px; width: 100%;">
        ${x}
      </div>

      <div style="font-size: 13px; color: #3A2B00; opacity: 0.9; text-align: center; line-height: 1.4; margin: 6px 0 10px;">
        ${a.voucher.instructions}
      </div>

      ${H?`
        <div style="display:flex; align-items:center; justify-content:center; padding-top: 8px;">
          <img src="${H}" alt="Woolsocks" style="height: 36px; width: auto; display: block;" />
        </div>
      `:""}
    </div>
  `,document.body.appendChild(c);try{const i=window.location.hostname,g=window.localStorage.getItem("__wsMinimizedBannerMap"),k=(g?JSON.parse(g):{})[i];if(k&&typeof k.until=="number"&&Date.now()<k.until){st();try{const _=document.getElementById("woolsocks-voucher-minimized");if(_&&k.corner){_.style.top="auto",_.style.bottom="auto",_.style.left="auto",_.style.right="auto";const[C,tt]=k.corner.split("-");C==="top"?_.style.top="20px":_.style.bottom="20px",tt==="left"?_.style.left="20px":_.style.right="20px"}}catch{}c.style.display="none"}}catch{}let W;const Y=3e4;function q(){W&&window.clearTimeout(W),W=window.setTimeout(()=>{document.body.contains(c)&&c.style.display!=="none"&&Ct()},Y)}function Q(){q()}if(q(),c.addEventListener("click",Q),c.addEventListener("pointerdown",Q),c.addEventListener("pointermove",Q),c.addEventListener("wheel",Q),M){const i=document.getElementById("voucher-carousel"),g=document.getElementById("carousel-indicators"),S=document.getElementById("carousel-left-arrow"),k=document.getElementById("carousel-right-arrow"),_=c.querySelector('span[style*="background: #8564FF"]');if(i&&g&&S&&k&&_){let C=function(I){if(y=I,i){const E=i.offsetWidth;let T=0;if(B===2){const K=(E-N)/2;T=I*N-K,T=Math.max(0,T)}else if(B>=3){const K=(E-N)/2;T=I*N-K,T=Math.max(0,T)}i.scrollLeft=T}},tt=function(){if(!i)return y;const I=i.scrollLeft,E=i.offsetWidth;if(B===2){const T=(E-N)/2,K=I+T,yt=Math.round(K/N);return Math.max(0,Math.min(B-1,yt))}else if(B>=3){const T=(E-N)/2,K=I+T,yt=Math.round(K/N);return Math.max(0,Math.min(B-1,yt))}return y},L=function(){const I=tt();if(I!==y){y=I,g&&g.querySelectorAll(".carousel-dot").forEach((K,yt)=>{const ft=K;yt===y?(ft.style.background="#0F0B1C",ft.style.borderRadius="3px"):(ft.style.background="#D1D5DB",ft.style.borderRadius="50%")}),S&&(S.style.opacity=y===0?"0.5":"1",S.style.pointerEvents=y===0?"none":"auto"),k&&(k.style.opacity=y===B-1?"0.5":"1",k.style.pointerEvents=y===B-1?"none":"auto");const E=s[y];if(E&&_){const T=E.cashbackRate||0,K=(n*T/100).toFixed(2);_.textContent=`€${K}`}}},y=0;const N=267,B=s.length;let at=0,ct=0,X=!1;i.addEventListener("touchstart",I=>{at=I.touches[0].clientX,ct=i?.scrollLeft||0,X=!0}),i.addEventListener("touchmove",I=>{if(!X||!i)return;I.preventDefault();const E=I.touches[0].clientX,T=at-E;i.scrollLeft=ct+T}),i.addEventListener("touchend",()=>{if(!X||!i)return;X=!1;const I=N/3,E=ct-i.scrollLeft;Math.abs(E)>I?E>0&&y<B-1?C(y+1):E<0&&y>0?C(y-1):C(y):C(y)}),i.addEventListener("scroll",()=>{X||L(),q()}),window.addEventListener("resize",()=>{setTimeout(()=>{L()},100)}),i.addEventListener("mousedown",I=>{at=I.clientX,ct=i?.scrollLeft||0,X=!0,i&&(i.style.cursor="grabbing")}),i.addEventListener("mousemove",I=>{if(!X||!i)return;I.preventDefault();const E=I.clientX,T=at-E;i.scrollLeft=ct+T}),i.addEventListener("mouseup",()=>{if(!X||!i)return;X=!1,i.style.cursor="grab";const I=N/3,E=ct-i.scrollLeft;Math.abs(E)>I?E>0&&y<B-1?C(y+1):E<0&&y>0?C(y-1):C(y):C(y)}),i.addEventListener("mouseleave",()=>{X&&i&&(X=!1,i.style.cursor="grab",C(y))}),S.addEventListener("click",()=>{y>0&&C(y-1)}),k.addEventListener("click",()=>{y<B-1&&C(y+1)}),g.addEventListener("click",I=>{const E=I.target;if(E.classList.contains("carousel-dot")){const T=parseInt(E.dataset.index||"0");C(T)}}),i.addEventListener("click",I=>{const T=I.target.closest(".voucher-card");if(T&&!X){const K=parseInt(T.dataset.index||"0");C(K)}})}}let p=null;function st(){if(p&&document.body.contains(p))return;const i=(()=>{try{const L=window.location.hostname;return L.startsWith("www.")?L.substring(4):L}catch{return"this site"}})();p=document.createElement("div"),p.id="woolsocks-voucher-minimized",p.style.cssText=["position: fixed","top: 20px","right: 20px","z-index: 2147483647","display: flex","min-width: 200px","max-width: 80vw","max-height: 775px","padding: 4px 8px","flex-direction: column","align-items: center","border-radius: 8px","background: var(--brand, #FDC408)","box-shadow: -2px 2px 4px 0 rgba(0, 0, 0, 0.08)","cursor: pointer","color: #0F0B1C","box-sizing: border-box"].join(";")+";",p.innerHTML=`
      <div style="display: flex; align-items: center; justify-content: space-between; padding-left: 0; padding-right: 8px; padding-top: 0; padding-bottom: 0; width: 100%; height: 32px;">
        <div style="display: flex; gap: 4px; align-items: center; padding: 0 2px;">
          <div style="display: flex; padding: 2px 4px; justify-content: center; align-items: center; gap: 8px; border-radius: 6px; background: #8564FF; color: #FFF; font-family: Woolsocks, sans-serif; font-size: 16px; font-weight: 400; line-height: 1.45; white-space: nowrap;">€${b}</div>
          <div style="font-family: Woolsocks, sans-serif; font-size: 14px; font-weight: 400; line-height: 1.45; color: #100B1C; letter-spacing: 0.1px; white-space: nowrap;">Savings available at ${i}</div>
        </div>
        <div aria-hidden="true" style="display:flex; align-items:center; justify-content:center; width: 32px; height: 32px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M11.9999 13.5858L17.2928 8.29289L18.707 9.70711L12.707 15.7071C12.3165 16.0976 11.6833 16.0976 11.2928 15.7071L5.29282 9.70711L6.70703 8.29289L11.9999 13.5858Z" fill="#0F0B1C"/>
          </svg>
        </div>
      </div>
    `;let g=!1,S=0,k=0,_=0,C=0,tt=!1;p.addEventListener("mousedown",L=>{g=!0,tt=!1,S=L.clientX,k=L.clientY;const y=p.getBoundingClientRect();_=y.left,C=y.top,p.style.cursor="grabbing"}),document.addEventListener("mousemove",L=>{if(!g)return;const y=L.clientX-S,N=L.clientY-k;(Math.abs(y)>3||Math.abs(N)>3)&&(tt=!0);const B=_+y,at=C+N;p.style.top="auto",p.style.bottom="auto",p.style.left="auto",p.style.right="auto",p.style.left=B+"px",p.style.top=at+"px"}),document.addEventListener("mouseup",()=>{if(!g)return;g=!1,p.style.cursor="pointer";const L=p.getBoundingClientRect(),y=L.left+L.width/2,N=L.top+L.height/2,B=window.innerWidth,at=window.innerHeight,ct=y<B/2,X=N<at/2;p.style.transition="top 0.2s ease, bottom 0.2s ease, left 0.2s ease, right 0.2s ease",p.style.top="auto",p.style.bottom="auto",p.style.left="auto",p.style.right="auto",X?p.style.top="20px":p.style.bottom="20px",ct?p.style.left="20px":p.style.right="20px",setTimeout(()=>{p&&(p.style.transition="")},250)}),p.addEventListener("click",()=>{if(tt)return;const L=p.getBoundingClientRect(),y=L.left+L.width/2,N=L.top+L.height/2,B=y<window.innerWidth/2,at=N<window.innerHeight/2;try{p&&p.parentNode&&p.parentNode.removeChild(p)}finally{p=null}c.style.display="block",c.style.top="auto",c.style.left="auto",c.style.right="auto",c.style.bottom="auto",at?c.style.top="20px":c.style.bottom="20px",B?c.style.left="20px":c.style.right="20px",c.style.opacity="0",c.style.transform="translateY(10px) scale(0.95)",requestAnimationFrame(()=>{c.style.opacity="1",c.style.transform="translateY(0) scale(1)"})}),document.body.appendChild(p)}function Ct(){m(3e5);try{const g=window.location.hostname,S=Date.now()+3e5,k=window.localStorage.getItem("__wsMinimizedBannerMap"),_=k?JSON.parse(k):{};_[g]={until:S,cashbackAmount:typeof b=="string"?b:String(b),corner:(()=>{try{const C=c.getBoundingClientRect(),tt=C.left+C.width/2,L=C.top+C.height/2,y=tt<window.innerWidth/2;return`${L<window.innerHeight/2?"top":"bottom"}-${y?"left":"right"}`}catch{return"top-right"}})()},window.localStorage.setItem("__wsMinimizedBannerMap",JSON.stringify(_))}catch{}c.style.opacity="0",c.style.transform="translateY(10px) scale(0.95)",setTimeout(()=>{const g=c.getBoundingClientRect(),S=g.left+g.width/2,k=g.top+g.height/2,_=S<window.innerWidth/2,C=k<window.innerHeight/2;c.style.display="none",st(),p&&(p.style.top="auto",p.style.bottom="auto",p.style.left="auto",p.style.right="auto",C?p.style.top="20px":p.style.bottom="20px",_?p.style.left="20px":p.style.right="20px")},300)}let l=!1,D=0,R=0,nt=0,dt=0;c.addEventListener("mousedown",i=>{const g=i.target;if(g.tagName==="BUTTON"||g.closest("button"))return;l=!0,D=i.clientX,R=i.clientY;const S=c.getBoundingClientRect();nt=S.left,dt=S.top,c.style.transition="opacity 0.3s ease",c.style.cursor="grabbing"}),document.addEventListener("mousemove",i=>{if(!l)return;const g=i.clientX-D,S=i.clientY-R,k=nt+g,_=dt+S;c.style.top="auto",c.style.bottom="auto",c.style.left="auto",c.style.right="auto",c.style.left=k+"px",c.style.top=_+"px"}),document.addEventListener("mouseup",()=>{if(!l)return;l=!1,c.style.cursor="move";const i=c.getBoundingClientRect(),g=i.left+i.width/2,S=i.top+i.height/2,k=window.innerWidth,_=window.innerHeight,C=g<k/2,tt=S<_/2;c.style.transition="top 0.3s ease, bottom 0.3s ease, left 0.3s ease, right 0.3s ease, opacity 0.3s ease, transform 0.3s ease",c.style.top="auto",c.style.bottom="auto",c.style.left="auto",c.style.right="auto",tt?c.style.top="20px":c.style.bottom="20px",C?c.style.left="20px":c.style.right="20px"}),setTimeout(()=>{c.style.opacity="1",c.style.transform="translateY(0) scale(1)"},100),document.addEventListener("mousemove",()=>q(),{passive:!0}),document.addEventListener("mouseup",()=>q(),{passive:!0}),document.getElementById("ws-close")?.addEventListener("click",()=>{Ct()}),document.getElementById("ws-use-voucher")?.addEventListener("click",()=>{const i=z?.url||t.voucherProductUrl;if(!i)return;let g=i;if(g.includes("/products/")&&!g.includes("amount=")){const S=Math.round(n*100),k=g.includes("?")?"&":"?";g=`${g}${k}amount=${S}`}try{window.postMessage({type:"WS_OPEN_URL",url:g},window.location.origin)}catch{}m(300*1e3),c.remove()})}
