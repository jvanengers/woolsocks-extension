name: Lokalise Translation Sync

on:
  # Push workflow: When translation files change in GitHub, push to Lokalise
  push:
    branches:
      - main
    paths:
      - 'src/shared/i18n.ts'
      - 'translations/**'
  
  # Pull workflow: Daily sync from Lokalise to GitHub
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  
  # Manual trigger
  workflow_dispatch:

jobs:
  # Job 1: Push changes from GitHub to Lokalise
  push-to-lokalise:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Extract translations to JSON
        run: |
          # Create translations directory if it doesn't exist
          mkdir -p translations
          
          # Extract translations from i18n.ts to JSON format
          node scripts/extract-translations-for-sync.js
      
      - name: Install Lokalise CLI
        run: |
          # Install Lokalise CLI
          curl -sf https://lokalise.com/cli/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify installation
          echo "Verifying Lokalise CLI installation..."
          $HOME/.local/bin/lokalise2 --version
      
      - name: Push to Lokalise
        run: |
          # Use full path to lokalise2 CLI
          LOKALISE_CLI="$HOME/.local/bin/lokalise2"
          
          # Upload English translations
          $LOKALISE_CLI --token ${{ secrets.LOKALISE_API_TOKEN }} --project-id ${{ secrets.LOKALISE_PROJECT_ID }} file upload \
            --file-path translations/en.json \
            --lang-iso en \
            --replace-modified
          
          # Upload other language files
          for lang in nl de fr it es; do
            if [ -f "translations/${lang}.json" ]; then
              echo "Uploading ${lang} translations..."
              $LOKALISE_CLI --token ${{ secrets.LOKALISE_API_TOKEN }} --project-id ${{ secrets.LOKALISE_PROJECT_ID }} file upload \
                --file-path translations/${lang}.json \
                --lang-iso ${lang} \
                --replace-modified
            fi
          done

  # Job 2: Pull changes from Lokalise to GitHub
  pull-from-lokalise:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Lokalise CLI
        run: |
          # Install Lokalise CLI
          curl -sf https://lokalise.com/cli/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify installation
          echo "Verifying Lokalise CLI installation..."
          $HOME/.local/bin/lokalise2 --version
      
      - name: Pull from Lokalise
        run: |
          # Use full path to lokalise2 CLI
          LOKALISE_CLI="$HOME/.local/bin/lokalise2"
          
          # Create translations directory
          mkdir -p translations
          
          # Download translations from Lokalise
          $LOKALISE_CLI --token ${{ secrets.LOKALISE_API_TOKEN }} --project-id ${{ secrets.LOKALISE_PROJECT_ID }} file download \
            --format json \
            --unzip-to translations \
            --export-sort first_added
      
      - name: Update i18n.ts with new translations
        run: |
          # Update the i18n.ts file with translations from Lokalise
          node scripts/update-i18n-from-lokalise.js
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update translations from Lokalise'
          title: 'üåê Update translations from Lokalise'
          body: |
            This PR contains updated translations from Lokalise.
            
            **Changes:**
            - Updated translation files from Lokalise
            - Updated `src/shared/i18n.ts` with new translations
            
            **Review:**
            - Please review the changes carefully
            - Test the extension with updated translations
            - Merge when ready
          branch: update-translations-from-lokalise
          delete-branch: true
